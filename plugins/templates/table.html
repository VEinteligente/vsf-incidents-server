{% extends 'dashboard/layout.html' %}
{% load eztables %}
{% load bootstrap3 %}
{% load static %}
{% load prettyjson %}


{% block extracss %}
    {% datatables_bootstrap_css %}
    <link rel="stylesheet" type="text/css" href="{% static 'plugins/pretty-json/css/pretty-json.css' %}" />
    <style type="text/css">
        .popover{
            max-width: 100%; /* Max Width of the popover (depending on the container!) */
        }
    </style>
{% endblock %}

{% block content %}
    <div class="box box-primary" style="margin-top:30px;">
        <div class="box-header with-border">
            <h3 class="box-title"> Search by dates:</h3>
        </div>
        <form id="date-form" action="" method="post">
            {% csrf_token %}
            <div class="box-body">

                {% if datepicker_form.non_field_errors %}
                    <div class="alert alert-danger alert-dismissible">
                        <button type="button" class="close" data-dismiss="alert" aria-hidden="true">
                            &times;
                        </button>
                        {% for non_field_error in datepicker_form.non_field_errors %}
                            {{ non_field_error }}
                        {% endfor %}
                    </div>
                {% endif %}
                <div class="row">
                    <div class="col-xs-5">
                        {% bootstrap_field datepicker_form.date_from %}
                    </div>
                    <div class="col-xs-5">
                        {% bootstrap_field datepicker_form.date_to %}
                    </div>
                </div>
            </div>
            <div class="box-footer text-right">
                <input id="date-search-button" class="btn btn-flat btn-primary" type="submit" value="Search">
            </div>
        </form>
    </div>
    <div class="table-responsive">
        <table id="principal-table">
            <thead>
                {% for table_title in titles %}
                    {% if  table_title == "checkbox" %}

                    <th><input type="checkbox" name="select_all" value="1" id="example-select-all"></th>
                    {% else %}
                    <th class="select-filter"> {{ table_title|title }} </th>
                    {% endif %}
                {% endfor %}
            </thead>
            <tfoot>
                {% for table_title in titles %}
                    {% if  table_title == "checkbox" %}
                    <th></th>
                    {% else %}
                    <th class="select-filter"> {{ table_title|title }} </th>
                    {% endif %}
                {% endfor %}
            </tfoot>
        </table>
    </div>

    {% if form %}

    <div class="box box-primary" style="margin-top:30px;">
        <div class="box-header with-border">
            <h3 class="box-title"> Create Event</h3>
        </div>
        <form id="event-form" action="" method="post">
            {% csrf_token %}
            <div class="box-body">

                {% if form.non_field_errors %}
                    <div class="alert alert-danger alert-dismissible">
                        <button type="button" class="close" data-dismiss="alert" aria-hidden="true">
                            &times;
                        </button>
                        {% for non_field_error in form.non_field_errors %}
                            {{ non_field_error }}
                        {% endfor %}
                    </div>
                {% endif %}
                {% bootstrap_field form.identification %}
                {% bootstrap_field form.type %}
                {% bootstrap_field form.isp %}
                <div class="row">

                    <div class="col-xs-5">
                        {% bootstrap_field form.start_date %}
                    </div>
                    <div class="col-xs-5">
                        {% bootstrap_field form.end_date %}
                    </div>
                    <div class="col-xs-2">
                        {% bootstrap_field form.open_ended %}
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-4">
                        {% bootstrap_field form.target_type %}
                    </div>
                    <div class="col-xs-8">
                        {% bootstrap_field form.target_domain %}
                        {% bootstrap_field form.target_url %}
                        {% bootstrap_field form.target_ip %}
                    </div>
                </div>

                {% bootstrap_field form.public_evidence %}
                {% bootstrap_field form.private_evidence %}

                {% bootstrap_field form.flags %}

            </div>
            <div class="box-footer text-right">
                <input id="create-event-button" class="btn btn-flat btn-primary" type="submit" value="Save">
            </div>
        </form>
    </div>

    <div class="box box-primary" style="margin-top:30px;">
        <div class="box-header with-border">
            <h3 class="box-title"> Flags Selected</h3>
        </div>
        <div class="box-body">
            <table id="selected-table">
                <thead>
                    <th>Flag ID</th>
                    <th>Flag</th>
                    <th>Measurement</th>
                    <th>Input</th>
                    <th>Action</th>
                </thead>
            </table>
        </div>
    </div>
    {% endif %}


    <div class="modal fade" id="test_key-modal" role="dialog">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Test Keys</h4>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6 form-group">
                        {% prettyjson dummyJSON %}
                        {# <textarea id="modal-textarea" class="col-md-12 form-control" rows="10"></textarea>#}
                    </div>
                    <div class="col-md-6 from-group">
                        <div class="form-group">
                            <span id="modal-json-result"></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}


{% block extrajs %}
{% prettyjson_setup jquery=False %}
{# <script type="text/javascript" src="{% static 'plugins/pretty-json/libs/underscore-min.js' %}" ></script>
<script type="text/javascript" src="{% static 'plugins/pretty-json/libs/backbone-min.js' %}" ></script>
<script type="text/javascript" src="{% static 'plugins/pretty-json/build/pretty-json-min.js' %}"></script>#}
<script type="application/javascript">

    $(function () {

        // disableEventField: params bool Boolean.
        // Enable or Disable event form fields isp, target url, target site,
        // target ip, start_date and end date
        function disableEventField(bool){
            $("#id_isp").prop('disabled', bool);
            $("#id_target_url").prop('disabled', bool);
            $("#id_target_site").prop('disabled', bool);
            $("#id_target_ip").prop('disabled', bool);
        }

        // checkDisableEventField
        // Enable or not event fields. This is when if an event has flags,
        // this fields are automatic fulled by flags data. Otherwise, this
        // fields must be fulled by user.
        function checkDisableEventField(){
            var flags = $( '#id_flags' );
            var disable_bool = false;
            if (flags.val() != ""){
                disable_bool = true;
            }else{
                disable_bool = false;
            }
            disableEventField(disable_bool);

        }

        // Ajax URL who fulled principal datatable
        var url_datatable = '{{url_ajax}}';

        // Columns to be render for principal datatable
        var list = {{ aoColumns_json|safe }};

        // Render special columns according header title of each column
        var arrayLength = list.length;
        for (var i = 0; i < arrayLength; i++) {
            if (list[i]['mData'] == "checkbox"){
                list[i]['bSortable'] = false;
                list[i]['bSearchable'] = false;
                list[i]['mRender'] = function ( data ) {
                    return '<input type="checkbox" name="flag_checkbox" value="' + data + '">'
                    };

            }
            if (list[i]['mData'] == "report_id"){
                list[i]['mRender'] = function ( data ) {
                    if (data != null){
                        var url_report = "{% url 'measurements:measurement_front:detail-report' 'data' %}".replace('data', data)
                        url_report = "<a href='" + url_report + "'>" + data + "</a>";
                        return url_report;
                    }else{
                        return '';
                    }
                };
            }
            if (list[i]['mData'] == "flag"){
                 list[i]['mRender'] = function ( data, type, full ) {

                        var flag_icon = "";

                        if (data == 'hard'){
                            flag_icon = '<span title="Suggested Events" class="btn btn-xs btn-default" ' +
                                'data-toggle="popover" data-content="' +
                                ajax_and_render_suggested_events(full.checkbox) +
                                '">Hard ' +
                                '<i class="glyphicon glyphicon-flag" style="color: red;" aria-hidden="true"></i></span>';
                        }
                        if (data == 'soft'){
                            flag_icon = '<span title="Suggested Events" class="btn btn-xs btn-default" ' +
                                'data-toggle="popover" data-content="' +
                                ajax_and_render_suggested_events(full.checkbox) +
                                '">Soft ' +
                                '<i class="glyphicon glyphicon-flag" style="color: yellow;" aria-hidden="true"></i></span>';
                        }
                        if (data == 'muted'){
                            flag_icon = '<span class="">mute</span> ' +
                                '<i class="glyphicon glyphicon-flag" style="color: gray;" aria-hidden="true"></i>';
                        }

                        if (data == 'none'){
                            flag_icon = "<a class='add_manual_flag' data-content='" +
                                full.checkbox +
                                "'>No Flag</a>"
                        }

                        return flag_icon;
                    }
            }
            if (list[i]['mData'] == "test keys" || list[i]['mData'] == "annotations"){
                 list[i]['mRender'] = function ( data, type, full ) {

                        var test_key_content = data;

                        return '<textarea style="display: none;" class="test-key-area" metric-id="'
                            +
                            full.checkbox
                            +
                            "\">" + test_key_content + "</textarea> " +
                            '<button type="button" class="btn btn-xs btn-info test_key-button" metric-id="'
                            +
                            full.checkbox
                            +
                            '"> Open Test Keys </button>';
                    }
            }
            if (list[i]['mData'] == "test keys"){
                list[i]['bSearchable'] = false;
            }
            if (list[i]['mData'] == "status code match"){
                list[i]['bSearchable'] = false;
            }
            if (list[i]['mData'] == "headers match"){
                list[i]['bSearchable'] = false;
            }
            if (list[i]['mData'] == "body lenght match"){
                list[i]['bSearchable'] = false;
            }
            if (list[i]['mData'] == "body proportion"){
                list[i]['bSearchable'] = false;
            }
            if (list[i]['mData'] == "manual flag"){
                list[i]['mRender'] = function ( data, type, full ) {

                    var flag_icon = "";

                    if (data == true){
                        flag_icon = '<i class="glyphicon glyphicon-flag" style="color: black;" aria-hidden="true"></i><span class="hide">manual</span>';
                    }
                    if (data == false){
                        flag_icon = 'Automatic';
                    }

                    return flag_icon;
                }
            }
            if (list[i]['mData'] == "measurement"){
                 list[i]['mRender'] = function ( data, type, full ) {
                        if (data != null){
                            var url_measurement = "{% url 'measurements:measurement_front:detail-measurement' 'data' %}".replace('data', data);
                            url_measurement = "<a href='" + url_measurement + "'>" + data + "</a>";
                            return url_measurement
                        }else{
                            return '';
                        }
                   }
            }
            if (list[i]['mData'] == "control resolver answers"){
                 list[i]['mRender'] = function ( data, type, full ) {

                        var cr_answers_content = JSON.stringify(data, null, 2);

                        return '<textarea rows="6" class="cr-answers-area">' + cr_answers_content + '</textarea>';
                    }
            }
            if (list[i]['mData'] == "answers"){
                list[i]['mRender'] = function ( data, type, full ) {

                    var answers_content = JSON.stringify(data, null, 2);

                    return '<textarea rows="6" class="answers-area">' + answers_content + '</textarea>';
                }
            }
            if (list[i]['mData'] == "resolver hostname"){
                list[i]['mRender'] = function ( data, type, full ) {

                    var answers_content = JSON.stringify(data, null, 2);

                    return data + '<span class="'+ data +'"></span>';
                }
            }
        }


        var date_from = null;
        var date_to = null;
        //Principal Datatable

        var principal_table = $('#principal-table').DataTable({
            "bProcessing": true,
            "bServerSide": true,
            "sAjaxSource": url_datatable,
            "fnServerParams": function ( aoData ) {
                aoData.push( { "name": "date_from", "value": date_from } );
                aoData.push( { "name": "date_to", "value": date_to } );
            },
            "aoColumns": list,
            "fnDrawCallback": function( oSettings ) {
                fill_rows_tables();
                $('[data-toggle="popover"]').popover({
                    html: true
                });
            }
        });

        $('#date-form').submit(function(event) {
            event.preventDefault();
            /* Act on the event */
            date_from = $('#id_date_from').val();
            date_to = $('#id_date_to').val();
            principal_table.clear();
            principal_table.ajax.reload();
        });

        // Setup - add a text input to each footer cell
        $('#principal-table tfoot th').each( function () {
            var title = $(this).text();
            if (title != "") {
                $(this).html( '<input type="text" placeholder="Search '+title+'" />' );
            }
        } );

        // Apply the search
        principal_table.columns().every( function () {
            var that = this;

            $( 'input', this.footer() ).on( 'keyup change', function () {
                if ( that.search() !== this.value ) {
                    that
                        .search( this.value )
                        .draw();
                }
            } );
        } );

        // Selected flags table
        var selected_table = $('#selected-table').DataTable();

        var remove_button = '<input class="btn btn-flat btn-primary remove-btn" type="submit" value="Remove">'


        // Start date and end date datepicker widget
        $('#id_start_date').datepicker({
        });
        $('#id_end_date').datepicker({
        });

        $('#id_date_from').datepicker({
            format: 'yyyy-mm-dd'
        });
        $('#id_date_to').datepicker({
            format: 'yyyy-mm-dd'
        });

        // Test key button click action
        $(document).on("click", ".test_key-button", function () {
            var metric_id = $(this).attr('metric-id');
            var test_keys = $('.test-key-area[metric-id="'+ metric_id +'"]').html();
            $('div.jsonwidget textarea').val(test_keys);
            $('#test_key-modal').modal('show');
        });

        // Selected Table's remove button click action
        $(document).on( 'click', '.remove-btn', function () {
             var flags = $( '#id_flags' );
            var row = selected_table.row( $(this).parents('tr') );


            var id_flag = row.data()[0];
            row.remove().draw();
            var flag_index = flags.val().indexOf(id_flag);
            flags.val(
                    flags.val().substring(
                            0,
                            flag_index
                    ) +
                    flags.val().substring(
                            flag_index + id_flag.length + 1 ,
                            flags.val().length
                    )
            );

            var principal_rows = $('#principal-table').find('tbody').find('tr');
            $(principal_rows).each(function(index) {
                row = principal_rows[index];
                var row_id = row.childNodes[0].getElementsByTagName('input')[0].value;
                if (row_id == id_flag){
                    $(this).removeClass('selected');
                }
                if( $( this ).hasClass( 'selected' ) ){
                    $(this).find(":checkbox").prop("checked", true);
                }else{
                    $(this).find(":checkbox").prop("checked", false);

                }
            });

            checkDisableEventField();

        });

        // Handle click on a row of principal datatable
        $('#principal-table tbody').on('click', 'tr', function () {

            var flags = $( '#id_flags' );
            var id_flag = $( this ).context.childNodes[0].getElementsByTagName('input')[0].value;

            var flag = $( this ).context.childNodes[1].innerText;
            var measurement = $( this ).context.childNodes[3].innerText;
            var input = $( this ).context.childNodes[4].innerText;

            $( this ).toggleClass('selected');
            if( $( this ).hasClass( 'selected' ) ){
                $(this).find(":checkbox").prop("checked", true);
                var selected_rows = $('#selected-table').find('tbody').find('tr');
                var check_existed = false;
                $(selected_rows).each(function(index) {
                    var row = selected_rows[index];
                    var row_id = row.childNodes[0].innerText;
                    if (row_id == id_flag){
                        check_existed = true;
                    }
                });
                if (check_existed == false){
                    // Add id in hidden input
                    flags.val( flags.val() + id_flag + '&');
                    // Add row to selected table
                    selected_table.row.add([
                        id_flag,
                        flag,
                        measurement,
                        input,
                        remove_button
                    ]).draw();
                }
            }else{
                $(this).find(":checkbox").prop("checked", false);
                // Remove id from hidden input
                var flag_index = flags.val().indexOf(id_flag);
                flags.val(
                        flags.val().substring(
                                0,
                                flag_index
                        ) +
                        flags.val().substring(
                                flag_index + id_flag.length + 1 ,
                                flags.val().length
                        )
                );

                $('#example-select-all').prop("checked", false);

                var selected_rows = $('#selected-table').find('tbody').find('tr');
                $(selected_rows).each(function(index) {
                    row = selected_rows[index];
                    row_id = row.childNodes[0].innerText;
                    if (row_id == id_flag){
                        var removed = selected_table.row(index);
                        removed.remove().draw();
                    }
                });
            }

            checkDisableEventField();

        });

        // Handle click on "Select all" control Principal datatable
        $('#example-select-all').on('click', function(){
            var flags = $( '#id_flags' );
            // Get all rows with search applied
            var rows = $('#principal-table').find('tbody').find('tr');
            // Check/uncheck checkboxes for all rows in the table
            $('input[type="checkbox"]', rows).prop('checked', this.checked);
            $(rows).each(function() {
               var checked = $('input[type="checkbox"]', rows).prop('checked');
                var id_flag = $( this ).context.childNodes[0].getElementsByTagName('input')[0].value;

                var flag = $( this ).context.childNodes[1].innerText;
                var measurement = $( this ).context.childNodes[3].innerText;
                var input = $( this ).context.childNodes[4].innerText;

                if(checked){
                    $(this).addClass('selected', checked);
                    disableEventField(true);
                }else{
                    $(this).removeClass('selected');
                    disableEventField(false);
                }

                if( $( this ).hasClass( 'selected' ) ){
                    $(this).find(":checkbox").prop("checked", true);

                    var selected_rows = $('#selected-table').find('tbody').find('tr');
                    var check_existed = false;
                    $(selected_rows).each(function(index) {
                        row = selected_rows[index];
                        row_id = row.childNodes[0].innerText;
                        if (row_id == id_flag){
                            check_existed = true;
                        }
                    });
                    if (check_existed == false){
                        // Add id in hidden input
                        flags.val( flags.val() + id_flag + '&');
                        // Add row to selected table
                        selected_table.row.add([
                                id_flag, flag, measurement, input,remove_button
                            ]).draw();
                    }
                }else{
                    $(this).find(":checkbox").prop("checked", false);
                    // Remove id from hidden input
                    var flag_index = flags.val().indexOf(id_flag);
                    flags.val(
                            flags.val().substring(
                                    0,
                                    flag_index
                            ) +
                            flags.val().substring(
                                    flag_index + id_flag.length + 1 ,
                                    flags.val().length
                            )
                    );

                    var selected_rows = $('#selected-table').find('tbody').find('tr');
                    $(selected_rows).each(function(index) {
                        // row = selected_rows[index];
                        // row_id = row.childNodes[0].innerText;
                        // if (row_id == id_flag){
                        var removed = selected_table.row(index);
                        removed.remove().draw();
                        // }
                    });

                }

            });

            checkDisableEventField();
        });


        // This is when flag hidden input have a value when DOM recently charge
        function fill_rows_tables() {
            // body...
            var flags = $( '#id_flags' ).val();

            var array = flags.split("&");
            array.pop();

            for (i = 0; i < array.length; i++) {
                var id_flag = array[i];
                var principal_rows = $('#principal-table').find('tbody').find('tr');
                $(principal_rows).each(function(index) {
                    var row = principal_rows[index];
                    var row_id = row.childNodes[0].getElementsByTagName('input')[0].value;
                    if (row_id == id_flag){
                        $(this).toggleClass('selected');
                        var flag = $( this ).context.childNodes[1].innerText;
                        var measurement = $( this ).context.childNodes[3].innerText;
                        var input = $( this ).context.childNodes[4].innerText;

                        var selected_rows = $('#selected-table').find('tbody').find('tr');
                        var insert_row = false;
                        $(selected_rows).each(function(index) {

                            var row_selected_table = selected_rows[index];
                            var row_selected_table_id = row_selected_table.childNodes[0].getElementsByTagName('input')[0].value;
                            if (row_selected_table_id == id_flag){
                                insert_row = true;
                            }
                        });

                        if (insert_row) {
                            selected_table.row.add([
                                id_flag,
                                flag,
                                measurement,
                                input,
                                remove_button
                            ]).draw();
                        }
                    }
                    if( $( this ).hasClass( 'selected' ) ){
                        $(this).find(":checkbox").prop("checked", true);
                         // Add row to selected table
                    }else{
                        $(this).find(":checkbox").prop("checked", false);

                    }
                });
            }
        }

        function ajax_and_render_suggested_events(flag){
            var table = $('#data-toggle-suggested-events-table').html();
            var trows = "";
            var theres_no_events_or_error = true;
            var response = "";
            $.ajax({
                url: "{% url 'plugins:suggested-events-ajax' %}",
                method: 'GET',
                data: {'flag': flag},
                async: false,
                error: function(obj){
                    theres_no_events_or_error = false;
                    response = obj.responseJSON.message;
                },
                success: function(data){
                    if( data.events.length < 1 ){
                        theres_no_events_or_error = false;
                        response = "No events";
                    }
                    for(var i=0; i<data.events.length; i++){
                        var node = "<tr>" +
                            "<td>" + data.events[i].isp + "</td>" +
                            "<td>" + data.events[i].name + "</td>" +
                            "<td>" + data.events[i].start + "</td>" +
                            "<td>" + data.events[i].end + "</td>" +
                            "<td><a href='" + data.events[i].id + "' class='btn btn-sm btn-primary'>Add</a></td>" +
                            "</tr>";
                        trows = trows.concat(node);
                    }
                    table = table.replace('__table-rows__', trows);
                }
            });
            if ( theres_no_events_or_error == true ){
                return table
            }else{
                return response
            }
        }

        $(document).on("click", ".add_manual_flag", function(){
            var flag_id = $(this).attr('data-content');
            if(confirm("Are you sure you want to convert this measurement to a flag?")){
                $.ajax({
                    url: "{% url 'measurements:measurement_front:create_manual_flag' %}",
                    method: 'POST',
                    data: {
                        flag: flag_id
                    },
                    error: function(a, b , c){
                        principal_table.fnDraw();
                    },
                    success: function(data){
                        principal_table.fnDraw();
                    }
                });
            }
        });

    })

</script>
<script type="text/html" id="data-toggle-suggested-events-table">
    <table class='table table-responsive suggested-events-table'>
        <thead>
            <th>ISP</th>
            <th>Name</th>
            <th>Init</th>
            <th>End</th>
            <th>Actions</th>
        </thead>
        <tbody>
            __table-rows__
        </tbody>
    </table>
</script>
{% endblock %}
